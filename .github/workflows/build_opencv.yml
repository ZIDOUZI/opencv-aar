name: Build OpenCV AAR

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 0"
jobs:
  build_opencv:
    name: Build OpenCV for Android
    runs-on: ubuntu-latest
    # timeout-minutes: 120

    steps:
      - name: 1. Get Latest OpenCV Version
        id: get_version
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/opencv/opencv/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          if [ -z "$LATEST_TAG" ]; then
            echo "Error: Could not find latest OpenCV tag."
            exit 1
          fi
          echo "Found latest OpenCV version: $LATEST_TAG"
          echo "version=$LATEST_TAG" >> $GITHUB_OUTPUT

      - name: 2. Checkout OpenCV
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv
          path: opencv
          ref: ${{ steps.get_version.outputs.version }}

      - name: 3. Checkout OpenCV Contrib
        uses: actions/checkout@v4
        with:
          repository: opencv/opencv_contrib
          path: opencv_contrib
          ref: ${{ steps.get_version.outputs.version }}

      - name: 4. Set up Java (JDK 17)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: 5. Set up Android SDK/NDK
        uses: android-actions/setup-android@v3
        with:
          packages: >
            ndk;25.2.9519653
            cmake;3.22.1
            platform-tools
            platforms;android-34

      - name: 6. Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y python3-pip ant ninja-build
          pip3 install numpy

      - name: 7. Run OpenCV Build
        id: build
        run: |
          echo "Building OpenCV version ${{ steps.get_version.outputs.version }}..."
          echo "NDK Path: $ANDROID_NDK_HOME"
          echo "SDK Path: $ANDROID_SDK_ROOT"

          python3 opencv/platforms/android/build_sdk.py \
            --sdk_path $ANDROID_SDK_ROOT \
            --ndk_path $ANDROID_NDK_HOME \
            --extra_modules_path opencv_contrib \
            --no_samples_build \
            build_android \
            opencv

      - name: 8. Find the AAR file
        id: find_aar
        run: |
          AAR_PATH=$(find build_android -name "opencv-release.aar")
          if [ -z "$AAR_PATH" ]; then
            echo "Error: Could not find opencv-release.aar file."
            exit 1
          fi
          echo "Found AAR at: $AAR_PATH"
          echo "aar_path=$AAR_PATH" >> $GITHUB_OUTPUT

      - name: 9. Upload OpenCV AAR Artifact
        uses: actions/upload-artifact@v4
        with:
          name: opencv-${{ steps.get_version.outputs.version }}.aar
          path: ${{ steps.find_aar.outputs.aar_path }}
          retention-days: 28
